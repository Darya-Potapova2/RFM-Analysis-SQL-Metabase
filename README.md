# üß™ RFM-–∞–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑—ã –∞–ø—Ç–µ—á–Ω–æ–π —Å–µ—Ç–∏ —Å PostgreSQL

## üìå –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
–ü—Ä–æ–≤–µ—Å—Ç–∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –∫–ª–∏–µ–Ω—Ç–æ–≤ –∞–ø—Ç–µ—á–Ω–æ–π —Å–µ—Ç–∏ –º–µ—Ç–æ–¥–æ–º RFM –≤ PostgresSQL –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –°–ú–°-—Ä–∞—Å—Å—ã–ª–∫–∏.

## üõ† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
- **SQL:** –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (OVER()), –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (SUM, COUNT, MIN), –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏ (PERCENTILE_CONT), CTE, —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (CASE) –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, CROSS JOIN –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –ø–æ—Ä–æ–≥–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
- **BI:** Metabase –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞

## ‚öôÔ∏è –ú–µ—Ç—Ä–∏–∫–∏
–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è RFM-–º–æ–¥–µ–ª—å:

- **Recency (R)** ‚Äî –¥–∞–≤–Ω–æ—Å—Ç—å, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
- **Frequency (F)** ‚Äî —á–∞—Å—Ç–æ—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–∫—É–ø–æ–∫ –∫–ª–∏–µ–Ω—Ç–∞ –∑–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã–π –ø–µ—Ä–∏–æ–¥
- **Monetary (M)** ‚Äî –¥–µ–Ω—å–≥–∏, –æ–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫ 

–ù–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–µ–π –∫–ª–∏–µ–Ω—Ç—ã –±—ã–ª–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã –∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω—ã –≤ —Å–µ–≥–º–µ–Ω—Ç—ã (VIP, –°–ø—è—â–∏–µ, –ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ –∏ –¥—Ä.).

[üîó –ü—Ä–∏–º–µ—Ä –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö](data/sample_data.csv)

## SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –∏ —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
<details>
<summary>üîó SQL-–∑–∞–ø—Ä–æ—Å: –Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞—Å–∫—Ä—ã—Ç—å</summary>

````sql
-- –í—ã–≤–µ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫ —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏: –Ω–æ–º–µ—Ä –±–æ–Ω—É—Å–Ω–æ–π –∫–∞—Ä—Ç—ã, –¥–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏, —Å—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏.
with all_transactions as (
 	select card as client_id, doc_id,
      	datetime::date as transaction_date,
      	max(datetime::date) over () as current_dt,
      	summ_with_disc as summ
 	from bonuscheques
 	where card similar to '200%'
),
 
-- –í—ã–≤–µ—Å—Ç–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏: recency, frequency, monetary
fin_calculations as (
 	select client_id,
      	min(current_dt - transaction_date) as recency,
      	count(distinct doc_id) as frequency,
      	sum(summ) as monetary
 	from all_transactions
 	group by client_id
),
 
-- –†–∞—Å—á–µ—Ç –ø–æ—Ä–æ–≥–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —á–µ—Ä–µ–∑ 33 –∏ 66 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏
percentiles as (
 	select
      	percentile_cont(0.33) within group (order by recency) as recency_perc33,
      	percentile_cont(0.66) within group (order by recency) as recency_perc66,
      	percentile_cont(0.33) within group (order by frequency) as frequency_perc33,
      	percentile_cont(0.66) within group (order by frequency) as frequency_perc66,
      	percentile_cont(0.33) within group (order by monetary) as monetary_perc33,
      	percentile_cont(0.66) within group (order by monetary) as monetary_perc66
 	from fin_calculations
),
 
-- –ü—Ä–∏—Å–≤–æ–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –≥—Ä—É–ø–ø—ã –ø–æ —Ç—Ä–µ–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º
rfm as (
 	select client_id, f.recency, f.frequency, f.monetary,
      	case
           	when f.recency > recency_perc66 then 3
           	when f.recency > recency_perc33 then 2
           	else 1
      	end as recency_gr,
      	case
           	when f.frequency > frequency_perc66 then 1
           	when f.frequency > frequency_perc33 then 2
           	else 3
      	end as frequency_gr,
      	case
           	when f.monetary > monetary_perc66 then 1
           	when f.monetary > monetary_perc33 then 2
           	else 3
      	end as monetary_gr
      	from fin_calculations f
      	cross join percentiles p
),
 
-- –í—ã–≤–µ—Å—Ç–∏ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü RFM
all_rfm as (
 	select client_id, recency, recency_gr,
 	frequency, frequency_gr,
 	monetary, monetary_gr,
 	concat(recency_gr, frequency_gr, monetary_gr) as rfm
 	from rfm
 	order by rfm
)
 
-- –ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø–µ
/*select rfm, count(*)
from all_rfm
group by rfm*/
 
-- –∫–ª–∏–µ–Ω—Ç—ã —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º
select *,
 	case
      	when rfm in ('111') then 'VIP-–∫–ª–∏–µ–Ω—Ç—ã'
      	when rfm in ('121', '131', '123', '122', '113', '112') then '–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ'
      	when rfm in ('133', '132') then '–ù–æ–≤–∏—á–∫–∏'
      	when rfm in ('211', '212', '213', '221', '222', '223', '231', '232', '233') then '–°–ø—è—â–∏–µ'
      	when rfm in ('313', '312', '311') then '–ë—ã–≤—à–∏–µ –ª–æ—è–ª—å–Ω—ã–µ'
      	when rfm in ('321', '322', '323') then '–£—Ö–æ–¥—è—â–∏–µ'
      	when rfm in ('331', '332', '333') then '–ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ'
 	end as segment
from all_rfm
````
</details>

## –°–µ–≥–º–µ–Ω—Ç—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–∫—Ä–∞—Ç–∫–æ)
| –°–µ–≥–º–µ–Ω—Ç           | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞                     | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –°–ú–°-—Ä–∞—Å—Å—ã–ª–∫–µ                      |
| ----------------- | ---------------------------------- | ------------------------------------------------- |
| **VIP**           | –ü–æ–∫—É–ø–∞—é—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ, —á–∞—Å—Ç–æ –∏ –Ω–∞ –±–æ–ª—å—à—É—é —Å—É–º–º—É (111)       | –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏, –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–¥–∞—Ä–∫–∏ –∑–∞ –∫—Ä—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã     |
| **–ü–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–µ** | –ü–æ–∫—É–ø–∞—é—Ç –Ω–∞ –±–æ–ª—å—à—É—é —Å—É–º–º—É (131); –ø–æ–∫—É–ø–∞—é—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ, –Ω–æ –Ω–∞ –Ω–µ–±–æ–ª—å—à—É—é —Å—É–º–º—É (121, 122, 123, 113, 112)    | –£—á–∞—Å—Ç–∏–µ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–µ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–¥–±–æ—Ä–∫–∞ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏. –ê–∫—Ü–∏–∏, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–µ–≥–æ —á–µ–∫–∞               |
| **–ù–æ–≤–∏—á–∫–∏**      | –û–¥–Ω–∞ –ø–æ–∫—É–ø–∫–∞, –Ω–∏–∑–∫–∏–π –∏–ª–∏ —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫  | Welcome-—Ü–µ–ø–æ—á–∫–∞, –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –≤—Ç–æ—Ä—É—é –ø–æ–∫—É–ø–∫—É        |
| **–°–ø—è—â–∏–µ**       | –ü–æ–∫—É–ø–∞–ª–∏ –Ω–µ —Ç–∞–∫ –¥–∞–≤–Ω–æ, –∏—Ö –µ—â–µ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å (211, 212, 213, 221, 222, 223, 231, 232, 233)             | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ç–æ–≤–∞—Ä–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ –ø–æ–∫—É–ø–∞–ª–∏; ‚Äã‚Äã–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥–±–æ—Ä–∫–∏           |
| **–ë—ã–≤—à–∏–µ –ª–æ—è–ª—å–Ω—ã–µ**        | –ü–æ–∫—É–ø–∞–ª–∏ —á–∞—Å—Ç–æ, –Ω–æ –¥–∞–≤–Ω–æ (313, 312, 311) | –ë–æ–Ω—É—Å—ã –∑–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ, —Ä–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É |
| **–£—Ö–æ–¥—è—â–∏–µ**        | –ü–æ–∫—É–ø–∞–ª–∏ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–≤–Ω–æ –∏ —Ä–µ–¥–∫–æ (321, 322, 323) | –ê–∫—Ü–∏–∏ –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –∏–ª–∏ –Ω–æ–≤–∏–Ω–∫–∏; –æ–ø—Ä–æ—Å |


## üìä –î–∞—à–±–æ—Ä–¥
–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ —Å–æ–∑–¥–∞–Ω –≤ **Metabase**, —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–µ—Ä–∏–æ–¥–∞–º –∏ –∞–ø—Ç–µ–∫–∞–º.

[üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –¥–∞—à–±–æ—Ä–¥](http://metabase.simulative.ru/public/dashboard/771cd146-cb05-4dd6-8968-6565297fb38b)

<img src="dashboard/screenshots/dash_all.png" alt="–ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron" width="1000"/>

## üìÑ SQL-–∑–∞–ø—Ä–æ—Å—ã
–í—Å–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ SQL. –ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤:

- [–°—É–º–º–∞ –ø—Ä–æ–¥–∞–∂](sql/metabase/01_sum.sql)
- [–†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫–∞–∂–¥–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ](sql/metabase/02_clients.sql) 

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
rfm-metabase/
‚îÇ
‚îú‚îÄ‚îÄ data/                  
‚îÇ   ‚îî‚îÄ‚îÄ sample_data.csv    # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
‚îÇ
‚îú‚îÄ‚îÄ sql/                   
‚îÇ   ‚îú‚îÄ‚îÄ rfm_query/        # SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ metabase_query/   # SQL-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
‚îÇ
‚îú‚îÄ‚îÄ dashboard/             
‚îÇ   ‚îú‚îÄ‚îÄ screenshots/        # –°–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ dashboard_link.txt  # –°—Å—ã–ª–∫–∞  –Ω–∞ –¥–∞—à–±–æ—Ä–¥
‚îÇ
‚îî‚îÄ‚îÄ README.md              
```
